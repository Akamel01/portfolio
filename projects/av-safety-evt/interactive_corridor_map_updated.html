<!DOCTYPE html>
<html>

<head>
    <title>Corridor Trajectories - Interactive Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            background: #000;
        }

        #container {
            display: flex;
            flex-direction: row;
            /* Desktop: Left-Right */
            height: 100vh;
            width: 100vw;
        }

        #sidebar {
            width: 50%;
            /* 50-50 Split */
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #333;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
        }

        #map {
            width: 50%;
            /* 50-50 Split */
            height: 100%;
            background: #000;
        }

        video {
            width: 100%;
            max-height: 100%;
            /* Ensure fits in container */
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            background: #111;
        }

        .legend {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 8px;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-family: 'Roboto', sans-serif;
        }

        .legend h4 {
            margin: 0 0 8px;
            font-size: 14px;
            text-transform: uppercase;
            color: #ccc;
            letter-spacing: 1px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Mobile Layout */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
                /* Mobile: Top-Bottom */
            }

            #sidebar {
                width: 100%;
                height: 40vh;
                /* Adjust as needed */
                border-right: none;
                border-bottom: 1px solid #333;
            }

            #map {
                width: 100%;
                height: 60vh;
            }
        }



        /* Left-aligned zoom controls */
        .leaflet-top.leaflet-left {
            left: 10px;
        }
    </style>
</head>

<body>

    <div id="container">
        <div id="sidebar">
            <video id="main-player" controls muted playsinline loop poster="">
                <!-- Source will be replaced by JS -->
                Your browser does not support the video tag.
            </video>
        </div>

        <div id="map"></div>
    </div>

    <script>
        // Data injected from Python
        const sites = [{ "id": 1, "lat": 36.12753396653757, "lon": -115.16784764729418, "video": "assets/videos/site_1_trajectories.mp4" }, { "id": 2, "lat": 36.12523480684139, "lon": -115.16942185384138, "video": "assets/videos/site_2_trajectories.mp4" }, { "id": 3, "lat": 36.12353637526751, "lon": -115.17060556056786, "video": "assets/videos/site_3_trajectories.mp4" }, { "id": 4, "lat": 36.12206010355174, "lon": -115.17143912429619, "video": "assets/videos/site_4_trajectories.mp4" }, { "id": 5, "lat": 36.11984876505152, "lon": -115.17243427678098, "video": "assets/videos/site_5_trajectories.mp4" }, { "id": 6, "lat": 36.09743978532786, "lon": -115.17329400232005, "video": "assets/videos/site_6_trajectories.mp4" }, { "id": 7, "lat": 36.100765092918465, "lon": -115.17287972462898, "video": "assets/videos/site_7_trajectories.mp4" }, { "id": 8, "lat": 36.10404928886446, "lon": -115.1729378269039, "video": "assets/videos/site_8_trajectories.mp4" }, { "id": 9, "lat": 36.106564297188896, "lon": -115.17315277639331, "video": "assets/videos/site_9_trajectories.mp4" }, { "id": 10, "lat": 36.108687879533896, "lon": -115.17291679021784, "video": "assets/videos/site_10_trajectories.mp4" }, { "id": 11, "lat": 36.111279979290664, "lon": -115.17282438611129, "video": "assets/videos/site_11_trajectories.mp4" }, { "id": 12, "lat": 36.11474646906562, "lon": -115.17288650194261, "video": "assets/videos/site_12_trajectories.mp4" }, { "id": 13, "lat": 36.11709592318762, "lon": -115.17297217969137, "video": "assets/videos/site_13_trajectories.mp4" }];
        const mapCenter = [36.113757133279016, -115.17197020392231];

        // Initialize Map
        var map = L.map('map', {
            center: mapCenter,
            zoom: 14,
            zoomControl: false, // Move zoom control
            attributionControl: false
        });

        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        // Google Satellite Tiles
        L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            attribution: 'Map data Â©2024 Google'
        }).addTo(map);

        // Add Legend to Map
        var legend = L.control({ position: 'bottomleft' });

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<h4>Trajectory Legend</h4>';
            div.innerHTML += '<div class="legend-item"><span class="circle" style="background: rgb(231, 76, 60);"></span><span>Vehicle</span></div>';
            div.innerHTML += '<div class="legend-item"><span class="circle" style="background: rgb(243, 156, 18);"></span><span>Bicycle</span></div>';
            div.innerHTML += '<div class="legend-item"><span class="circle" style="background: rgb(46, 204, 113);"></span><span>Pedestrian</span></div>';
            return div;
        };

        legend.addTo(map);

        // Video Player Reference
        const player = document.getElementById('main-player');

        // Active marker tracking
        let activeCircle = null;
        const siteMarkers = [];

        // Add Markers
        sites.forEach(site => {
            // Circle Marker (No label)
            var circle = L.circleMarker([site.lat, site.lon], {
                radius: 8,
                fillColor: "#FF9500",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            // Interaction
            function activateSite() {
                // Reset previous active marker styling
                if (activeCircle) {
                    activeCircle.setStyle({
                        fillColor: "#FF9500",
                        radius: 8,
                        color: "#fff",
                        weight: 2
                    });
                }

                // Highlight current marker
                circle.setStyle({
                    fillColor: "#ff0000",
                    radius: 12,
                    color: "#ffdd00",
                    weight: 4
                });
                activeCircle = circle;

                // Update Video and Play
                player.src = site.video;
                player.load();

                // Attempt autoplay
                var playPromise = player.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        console.log("Autoplay started");
                    }).catch(error => {
                        console.error("Autoplay prevent:", error);
                    });
                }
            }

            // Click handler
            circle.on('click', activateSite);

            // Store reference for auto-play
            siteMarkers.push(circle);
        });

    </script>



    <!-- Auto-select Site 1 on load -->
    <script>
        sites.length > 0 && setTimeout(() => {
            // Randomly select a site index
            const randomIndex = Math.floor(Math.random() * siteMarkers.length);

            // Trigger click on the random marker
            // This will highlight the marker on the map AND play the video
            if (siteMarkers[randomIndex]) {
                siteMarkers[randomIndex].fire('click');
            }
        }, 500);
    </script>

</body>

</html>